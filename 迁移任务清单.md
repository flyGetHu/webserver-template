# Salvo Template 标准化迁移任务清单

## 项目概述
- **项目名称**: WebServer Template 标准化迁移
- **迁移目标**: 引入 salvo-template 的最佳实践，保留现有业务特色
- **预计工期**: 6-8 周
- **风险等级**: 低-中等

## 阶段一: 配置系统迁移 (1-2周)

### 任务 1.1: 环境准备
- [ ] **1.1.1** 创建迁移分支 `feature/salvo-standardization`
- [ ] **1.1.2** 备份当前配置文件到 `backup/` 目录
- [ ] **1.1.3** 确保开发环境可以正常运行现有项目
- [ ] **1.1.4** 准备测试数据和测试用例

**验收标准**: 
- 迁移分支创建成功
- 现有项目在新分支上正常运行
- 所有测试用例通过

### 任务 1.2: 依赖管理更新
- [ ] **1.2.1** 在 `Cargo.toml` 中添加 Figment 依赖
  ```toml
  figment = { version = "0.10.8", features = ["env", "toml"] }
  tracing-appender = "0.2.3"
  ```
- [ ] **1.2.2** 移除 config-rs 依赖
  ```toml
  # 注释或删除: config = "0.15.13"
  ```
- [ ] **1.2.3** 运行 `cargo check` 确保依赖解析正确
- [ ] **1.2.4** 更新 `Cargo.lock` 文件

**验收标准**: 
- 项目编译通过
- 新依赖正确安装
- 无依赖冲突

### 任务 1.3: 配置模块重构
- [ ] **1.3.1** 创建新的配置模块结构
  ```
  src/app/config/
  ├── mod.rs
  ├── db_config.rs
  └── log_config.rs
  ```
- [ ] **1.3.2** 从 salvo-template 复制 `log_config.rs`
- [ ] **1.3.3** 创建融合的 `db_config.rs` (结合两个项目优势)
- [ ] **1.3.4** 实现新的 `Config` 结构体
- [ ] **1.3.5** 实现 Figment 配置加载逻辑

**验收标准**: 
- 新配置模块编译通过
- 配置结构体定义完整
- 配置加载逻辑正确实现

### 任务 1.4: 配置文件迁移
- [ ] **1.4.1** 更新 `config/default.toml` 为新格式
- [ ] **1.4.2** 添加日志配置部分
- [ ] **1.4.3** 统一 JWT 配置格式 (expiry 改为秒)
- [ ] **1.4.4** 保留现有的数据库和 Redis 配置
- [ ] **1.4.5** 添加可选的 TLS 配置部分

**验收标准**: 
- 配置文件格式正确
- 所有必要配置项都已包含
- 环境变量覆盖功能正常

### 任务 1.5: 应用初始化更新
- [ ] **1.5.1** 更新 `src/app/mod.rs` 引入新配置模块
- [ ] **1.5.2** 修改应用初始化代码使用新配置系统
- [ ] **1.5.3** 更新所有使用配置的地方
- [ ] **1.5.4** 移除旧的 config-rs 相关代码

**验收标准**: 
- 应用启动正常
- 配置加载无错误
- 所有配置项都能正确读取

### 任务 1.6: 测试和验证
- [ ] **1.6.1** 测试默认配置加载
- [ ] **1.6.2** 测试环境变量覆盖功能
- [ ] **1.6.3** 测试不同环境配置文件加载
- [ ] **1.6.4** 运行现有测试用例确保无回归
- [ ] **1.6.5** 性能基准测试 (配置加载时间)

**验收标准**: 
- 所有配置测试通过
- 现有功能无回归
- 性能无明显下降

## 阶段二: 依赖注入标准化 (1-2周)

### 任务 2.1: 服务容器简化
- [ ] **2.1.1** 分析现有的 `AppServices` 结构
- [ ] **2.1.2** 移除复杂的依赖注入逻辑
- [ ] **2.1.3** 简化服务容器为简单的结构体
- [ ] **2.1.4** 保留所有现有服务的引用

**验收标准**: 
- 服务容器结构简化
- 所有服务仍可正常访问
- 代码更加简洁

### 任务 2.2: Depot 扩展实现
- [ ] **2.2.1** 创建 `DepotServiceExt` trait
- [ ] **2.2.2** 实现服务获取的便捷方法
- [ ] **2.2.3** 创建 `get_service!` 宏
- [ ] **2.2.4** 添加错误处理逻辑

**验收标准**: 
- Depot 扩展 trait 实现正确
- 宏定义语法正确
- 错误处理完善

### 任务 2.3: 服务注入中间件
- [ ] **2.3.1** 实现 `inject_services_middleware` 函数
- [ ] **2.3.2** 创建服务注入的 handler
- [ ] **2.3.3** 集成到路由初始化中
- [ ] **2.3.4** 测试服务注入功能

**验收标准**: 
- 中间件正确注入服务
- 所有路由都能访问服务
- 无性能问题

### 任务 2.4: 处理器重构
- [ ] **2.4.1** 选择 2-3 个处理器进行重构试点
- [ ] **2.4.2** 使用新的 Depot 服务获取方式
- [ ] **2.4.3** 验证功能正确性
- [ ] **2.4.4** 逐步重构所有处理器

**验收标准**: 
- 试点处理器重构成功
- 功能测试通过
- 代码更加简洁

### 任务 2.5: 测试和验证
- [ ] **2.5.1** 单元测试服务注入功能
- [ ] **2.5.2** 集成测试 API 端点
- [ ] **2.5.3** 性能测试服务获取效率
- [ ] **2.5.4** 错误场景测试

**验收标准**: 
- 所有测试通过
- 性能符合预期
- 错误处理正确

## 阶段三: 功能融合 (2-3周)

### 任务 3.1: JWT 认证标准化
- [ ] **3.1.1** 从 salvo-template 复制 JWT hoops
- [ ] **3.1.2** 适配现有的 JWT 配置
- [ ] **3.1.3** 保留现有的 Claims 结构
- [ ] **3.1.4** 集成到认证中间件

**验收标准**: 
- JWT 认证功能正常
- 现有 token 仍然有效
- 性能有所提升

### 任务 3.2: CORS 处理标准化
- [ ] **3.2.1** 引入 salvo-template 的 CORS 实现
- [ ] **3.2.2** 配置 CORS 策略
- [ ] **3.2.3** 测试跨域请求
- [ ] **3.2.4** 验证安全性

**验收标准**: 
- CORS 功能正常
- 跨域请求正确处理
- 安全策略有效

### 任务 3.3: 错误处理融合
- [ ] **3.3.1** 引入 salvo-template 的 AppError 设计
- [ ] **3.3.2** 保留现有的 ApiResponse 格式
- [ ] **3.3.3** 实现错误转换逻辑
- [ ] **3.3.4** 集成 request_id 追踪

**验收标准**: 
- 错误处理更加标准化
- API 响应格式保持不变
- request_id 追踪正常

### 任务 3.4: 路由系统优化
- [ ] **3.4.1** 引入 salvo-template 的路由组织方式
- [ ] **3.4.2** 保留现有的模块化结构
- [ ] **3.4.3** 优化 OpenAPI 文档生成
- [ ] **3.4.4** 统一中间件应用方式

**验收标准**: 
- 路由结构更加清晰
- OpenAPI 文档正确生成
- 中间件应用统一

### 任务 3.5: 中间件栈优化
- [ ] **3.5.1** 分析现有中间件执行顺序
- [ ] **3.5.2** 优化中间件配置
- [ ] **3.5.3** 移除冗余中间件
- [ ] **3.5.4** 性能测试

**验收标准**: 
- 中间件执行效率提升
- 功能无回归
- 配置更加简洁

## 阶段四: 性能优化 (1-2周)

### 任务 4.1: 性能基准测试
- [ ] **4.1.1** 建立性能基准测试套件
- [ ] **4.1.2** 测试关键 API 端点性能
- [ ] **4.1.3** 对比迁移前后性能
- [ ] **4.1.4** 识别性能瓶颈

**验收标准**: 
- 性能测试套件完整
- 性能数据准确
- 瓶颈识别清晰

### 任务 4.2: 代码优化
- [ ] **4.2.1** 优化服务调用链路
- [ ] **4.2.2** 减少不必要的内存分配
- [ ] **4.2.3** 优化数据库查询
- [ ] **4.2.4** 优化配置加载

**验收标准**: 
- 代码执行效率提升
- 内存使用优化
- 响应时间改善

### 任务 4.3: 代码重构和清理
- [ ] **4.3.1** 移除废弃代码
- [ ] **4.3.2** 统一代码风格
- [ ] **4.3.3** 优化导入语句
- [ ] **4.3.4** 添加必要的注释

**验收标准**: 
- 代码库更加整洁
- 代码风格统一
- 文档注释完善

## 阶段五: 文档和测试 (1周)

### 任务 5.1: 文档更新
- [ ] **5.1.1** 更新 README.md
- [ ] **5.1.2** 更新配置文档
- [ ] **5.1.3** 创建迁移指南
- [ ] **5.1.4** 更新 API 文档

**验收标准**: 
- 文档内容准确
- 示例代码正确
- 迁移指南完整

### 任务 5.2: 测试完善
- [ ] **5.2.1** 补充单元测试
- [ ] **5.2.2** 完善集成测试
- [ ] **5.2.3** 添加性能测试
- [ ] **5.2.4** 端到端测试

**验收标准**: 
- 测试覆盖率 > 80%
- 所有测试通过
- 测试稳定可靠

### 任务 5.3: 部署准备
- [ ] **5.3.1** 更新部署脚本
- [ ] **5.3.2** 验证环境配置
- [ ] **5.3.3** 准备回滚方案
- [ ] **5.3.4** 制定发布计划

**验收标准**: 
- 部署脚本正确
- 环境配置验证通过
- 回滚方案可行

## 质量检查清单

### 代码质量
- [ ] 所有代码通过 `cargo clippy` 检查
- [ ] 代码格式化 (`cargo fmt`) 通过
- [ ] 无编译警告
- [ ] 测试覆盖率达标

### 功能验证
- [ ] 所有现有 API 功能正常
- [ ] 新功能按预期工作
- [ ] 错误处理正确
- [ ] 性能符合要求

### 安全检查
- [ ] 依赖安全扫描通过
- [ ] 配置安全性验证
- [ ] 认证授权功能正常
- [ ] 敏感信息保护

### 文档完整性
- [ ] 代码注释完善
- [ ] API 文档准确
- [ ] 配置文档更新
- [ ] 迁移指南完整

## 风险控制

### 回滚策略
1. **配置回滚**: 保留原配置文件备份
2. **代码回滚**: 使用 Git 分支管理
3. **数据库回滚**: 确保数据库结构无变更
4. **服务回滚**: 准备快速回滚脚本

### 监控指标
- **性能指标**: 响应时间、吞吐量、内存使用
- **错误指标**: 错误率、异常日志
- **业务指标**: API 调用成功率、用户体验

### 应急预案
1. **性能问题**: 立即回滚到上一版本
2. **功能异常**: 启用降级模式
3. **配置错误**: 使用备份配置
4. **依赖问题**: 回滚依赖版本

## 完成标准

### 技术标准
- ✅ 所有测试用例通过
- ✅ 性能指标达到预期
- ✅ 代码质量检查通过
- ✅ 安全扫描无问题

### 业务标准
- ✅ 现有功能无回归
- ✅ API 兼容性保持
- ✅ 用户体验无影响
- ✅ 系统稳定性良好

### 文档标准
- ✅ 技术文档完整
- ✅ 用户文档更新
- ✅ 运维文档准确
- ✅ 迁移记录完整

---

**注意事项**:
1. 每个任务完成后需要进行代码审查
2. 关键节点需要进行性能测试
3. 保持与团队的沟通，及时反馈问题
4. 遵循渐进式迁移原则，确保系统稳定性
